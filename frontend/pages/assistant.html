<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TourSync - Band Manager Dashboard</title>

  <!-- Font Awesome icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
  />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --primary-color: #1e1b4b;
      --secondary-color: #312e81;
      --accent-color: #6366f1;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --background: #f9fafb;
      --surface: #ffffff;
      --border: #e5e7eb;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
    }

    .app-container {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      min-height: 100vh;
      gap: 0;
    }

    /* Sidebar Styles */
    .sidebar {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 2rem 1.5rem;
      overflow-y: auto;
    }

    .sidebar-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .logo-text {
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
      text-decoration: none;
    }

    .sidebar-menu {
      margin-bottom: 2rem;
    }

    .unified-menu-container {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .menu-section-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 1rem 0 0.5rem 0;
    }

    .management-menu-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .management-menu-item:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(3px);
    }

    .management-menu-item i {
      width: 20px;
      text-align: center;
    }

    .management-menu-item .fas.fa-chevron-right {
      margin-left: auto;
      font-size: 0.8rem;
      opacity: 0.6;
    }

    .offer-badge {
      background: var(--accent-color);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: auto;
      margin-right: 0.5rem;
    }

    .menu-divider {
      height: 1px;
      background: rgba(255, 255, 255, 0.2);
      margin: 1rem 0;
    }

    .sidebar-footer {
      margin-top: auto;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
    }

    .avatar-container {
      position: relative;
    }

    .avatar {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .user-info h4 {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .user-info p {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    /* Main Content Styles */
    .main-content {
      display: flex;
      flex-direction: column;
      background: var(--background);
    }

    .minimal-chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--surface);
      margin: 1rem;
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .minimal-chat {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
    }

    .chat-message {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .user-message .message-avatar {
      background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
    }

    .user-message {
      flex-direction: row-reverse;
    }

    .message-content {
      background: #f3f4f6;
      padding: 1rem 1.25rem;
      border-radius: 16px;
      max-width: 70%;
      word-wrap: break-word;
    }

    .user-message .message-content {
      background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
      color: white;
    }

    .message-content p {
      margin: 0;
      line-height: 1.6;
    }

    .minimal-input-area {
      padding: 1.5rem 2rem;
      background: var(--surface);
      border-top: 1px solid var(--border);
    }

    .minimal-input-wrapper {
      display: flex;
      align-items: flex-end;
      gap: 1rem;
      background: var(--background);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      transition: border-color 0.3s ease;
    }

    .minimal-input-wrapper:focus-within {
      border-color: var(--accent-color);
    }

    #user-input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      font-family: inherit;
      font-size: 1rem;
      line-height: 1.5;
      resize: none;
      min-height: 24px;
      max-height: 120px;
    }

    .minimal-send-btn {
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
    }

    .minimal-send-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .minimal-send-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Right Panel Styles */
    .right-panel {
      background: var(--surface);
      border-left: 1px solid var(--border);
      padding: 2rem 1.5rem;
      overflow-y: auto;
    }

    .band-card {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 2rem;
      cursor: pointer;
      transition: transform 0.3s ease;
      position: relative;
    }

    .band-card:hover {
      transform: translateY(-2px);
    }

    .band-image-container {
      position: relative;
      height: 200px;
      overflow: hidden;
    }

    .band-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.3s ease;
    }

    .band-card:hover .band-image {
      transform: scale(1.05);
    }

    .band-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: var(--accent-color);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      z-index: 3;
    }

    .band-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.5) 60%, rgba(0,0,0,0) 100%);
      padding: 15px 10px;
      z-index: 2;
    }

    .band-name {
      color: white;
      margin: 0 0 3px;
      font-size: 16px;
      font-weight: 600;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
    }

    .band-location {
      color: rgba(255,255,255,0.9);
      margin: 0;
      font-size: 12px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .band-genre {
      color: white;
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
    }

    .band-specs {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }

    .spec-item {
      color: white;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .click-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      color: #333;
      padding: 6px;
      border-radius: 50%;
      font-size: 12px;
      z-index: 3;
      transition: all 0.3s ease;
    }

    .panel-section {
      margin-bottom: 2rem;
    }

    .panel-section h3 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .showing-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      background: var(--background);
      border-radius: 12px;
      margin-bottom: 0.75rem;
      transition: all 0.3s ease;
    }

    .showing-item.clickable {
      cursor: pointer;
    }

    .showing-item.clickable:hover {
      background: #e5e7eb;
      transform: translateX(3px);
    }

    .showing-date {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      color: white;
      padding: 0.75rem;
      border-radius: 8px;
      margin-right: 1rem;
      min-width: 60px;
    }

    .showing-date .day {
      font-size: 1.2rem;
      font-weight: 700;
      line-height: 1;
    }

    .showing-date .month {
      font-size: 0.8rem;
      font-weight: 500;
      opacity: 0.9;
    }

    .showing-details {
      flex: 1;
    }

    .showing-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--text-primary);
    }

    .showing-time {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .showing-contact {
      font-size: 0.8rem;
      color: #666;
      font-style: italic;
    }

    .showing-indicator {
      margin-left: auto;
      color: #999;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .showing-item.clickable:hover .showing-indicator {
      color: var(--primary-color);
      transform: translateX(3px);
    }

    /* Typing Indicator */
    .typing-indicator .typing-dots {
      display: inline-block;
    }
    
    .typing-indicator .typing-dots span {
      animation: typing 1.4s infinite;
      opacity: 0;
      font-size: 20px;
      line-height: 1;
    }
    
    .typing-indicator .typing-dots span:nth-child(1) { animation-delay: 0s; }
    .typing-indicator .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
      0%, 60%, 100% { opacity: 0; }
      30% { opacity: 1; }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .app-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      
      .sidebar {
        display: none;
      }
      
      .right-panel {
        display: none;
      }
      
      .minimal-chat-container {
        margin: 0.5rem;
      }
      
      .minimal-chat {
        padding: 1rem;
      }
      
      .minimal-input-area {
        padding: 1rem;
      }
    }

    /* Mobile Header */
    .mobile-header {
      display: none;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 1rem;
      align-items: center;
      justify-content: space-between;
    }

    .mobile-header .logo-text {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .mobile-menu-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .mobile-header {
        display: flex;
      }
    }
  </style>
</head>
<body>  
  <!-- MOBILE HEADER -->
  <div class="mobile-header">
    <div class="logo-text">TourSync</div>
    <button class="mobile-menu-btn">
      <i class="fas fa-bars"></i>
    </button>
  </div>

  <!-- MAIN GRID LAYOUT -->
  <div class="app-container">
    <!-- SIDEBAR NAV -->
    <div class="sidebar">
      <div class="sidebar-header">
        <a href="../index.html">
          <div class="logo-text">TourSync</div>
        </a>
      </div>

      <div class="sidebar-menu">
        <!-- Consolidated Menu Container -->
        <div class="unified-menu-container">
          <div class="menu-section-header">
            <i class="fas fa-music"></i>
            <span>Band Management</span>
          </div>
          
          <div class="management-menu-item" onclick="showAnalyticsPopout(event)">
            <i class="fas fa-chart-line"></i>
            <span>Analytics</span>
            <i class="fas fa-chevron-right"></i>
          </div>
          <div class="management-menu-item" onclick="showTimelinePopout(event)">
            <i class="fas fa-route"></i>
            <span>Tour Timeline</span>
            <i class="fas fa-chevron-right"></i>
          </div>
          <div class="management-menu-item" onclick="showOffersPopout(event)">
            <i class="fas fa-calendar-check"></i>
            <span>Bookings</span>
            <div class="offer-badge">3</div>
            <i class="fas fa-chevron-right"></i>
          </div>
          <div class="management-menu-item" onclick="showSupportPopout(event)">
            <i class="fas fa-headset"></i>
            <span>Support</span>
            <i class="fas fa-chevron-right"></i>
          </div>
          <div class="management-menu-item" onclick="showSettingsPopout(event)">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
            <i class="fas fa-chevron-right"></i>
          </div>
          
          <div class="menu-divider"></div>
          
          <div class="menu-section-header">
            <i class="fas fa-folder-open"></i>
            <span>Tools & Resources</span>
          </div>
          
          <div class="management-menu-item" onclick="showDocumentsPopout(event)">
            <i class="fas fa-file-audio"></i>
            <span>Documents</span>
            <i class="fas fa-chevron-right"></i>
          </div>
          <div class="management-menu-item" onclick="showCalendarPopout(event)">
            <i class="fas fa-calendar-alt"></i>
            <span>Calendar</span>
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>
      </div>

      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="avatar-container">
            <div class="avatar">
              <span>BM</span>
            </div>
          </div>
          <div class="user-info">
            <h4>Band Manager</h4>
            <p>TourSync Pro</p>
          </div>
        </div>
      </div>  
    </div>

    <!-- CHAT CONTENT -->
    <div class="main-content">
      <div class="minimal-chat-container">
        <div class="minimal-chat" id="chatBox">
          <!-- Welcome message -->
          <div class="chat-message assistant-message">
            <div class="message-avatar">
              <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
              <p>🎸 Hey there! I'm Roadie, your AI tour assistant. I'm here to help you manage your band's tours, book venues, coordinate logistics, and keep everyone in sync on the road. What can I help you with today?</p>
            </div>
          </div>
        </div>

        <div class="minimal-input-area">
          <div class="minimal-input-wrapper">
            <textarea id="user-input" placeholder="Ask about tour planning, venue bookings, logistics..." rows="1"></textarea>
            <button class="minimal-send-btn" id="send-button" onclick="sendMessage()" title="Send message">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right-panel">
      <div class="band-card">
        <div class="band-image-container" onclick="showBandDetailsPopout(event)">
          <img
            src="https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb"
            alt="The Electric Collective Band"
            class="band-image"
          />
          <div class="band-badge">Your Band</div>
          <div class="band-overlay">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
              <div>
                <h3 class="band-name">The Electric Collective</h3>
                <p class="band-location">
                  <i class="fas fa-map-marker-alt"></i> Austin, Texas
                </p>
              </div>
              <p class="band-genre">Indie Rock</p>
            </div>
            <div class="band-specs">
              <div class="spec-item">
                <i class="fas fa-users"></i>
                <span>5 members</span>
              </div>
              <div class="spec-item">
                <i class="fas fa-calendar"></i>
                <span>15 shows</span>
              </div>
              <div class="spec-item">
                <i class="fas fa-route"></i>
                <span>3 states</span>
              </div>
            </div>
          </div>
          <div class="click-indicator">
            <i class="fas fa-expand-alt"></i>
          </div>
        </div>
      </div>

      <div class="panel-section">
        <h3>Upcoming Shows</h3>
        <div class="showing-item clickable" onclick="showVenueInfo('The Saxon Pub', 'info@saxonpub.com', '(512) 448-2552', 'June 15, 2025', '8:00 PM - 11:00 PM')">
          <div class="showing-date">
            <span class="day">15</span>
            <span class="month">Jun</span>
          </div>
          <div class="showing-details">
            <p class="showing-title">Live Performance</p>
            <p class="showing-time">8:00 PM - 11:00 PM</p>
            <p class="showing-contact">at The Saxon Pub</p>
          </div>
          <div class="showing-indicator">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>
        
        <div class="showing-item clickable" onclick="showVenueInfo('Antones Nightclub', 'booking@antones.net', '(512) 320-8424', 'June 22, 2025', '9:00 PM - 12:00 AM')">
          <div class="showing-date">
            <span class="day">22</span>
            <span class="month">Jun</span>
          </div>
          <div class="showing-details">
            <p class="showing-title">Headline Show</p>
            <p class="showing-time">9:00 PM - 12:00 AM</p>
            <p class="showing-contact">at Antone's Nightclub</p>
          </div>
          <div class="showing-indicator">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>

        <div class="showing-item clickable" onclick="showVenueInfo('Mohawk Austin', 'info@mohawkaustin.com', '(512) 666-0877', 'July 4, 2025', '7:00 PM - 10:00 PM')">
          <div class="showing-date">
            <span class="day">04</span>
            <span class="month">Jul</span>
          </div>
          <div class="showing-details">
            <p class="showing-title">Festival Set</p>
            <p class="showing-time">7:00 PM - 10:00 PM</p>
            <p class="showing-contact">at Mohawk Austin</p>
          </div>
          <div class="showing-indicator">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Band Manager Chat System
    console.log('🎸 Initializing TourSync chat system...');
    
    const API_BASE = "https://vesty-app-fastapi.onrender.com/api/langgraph";
    let THREAD_ID = localStorage.getItem("toursync_thread_id") || null;
    let isProcessing = false;

    // Create a new thread
    async function createThread() {
      try {
        console.log("Creating new thread...");
        const response = await fetch(`${API_BASE}/thread`, { 
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        THREAD_ID = data.thread_id;
        localStorage.setItem("toursync_thread_id", THREAD_ID);
        console.log("Created new thread:", THREAD_ID);
        return THREAD_ID;
      } catch (error) {
        console.error("Failed to create thread:", error);
        throw error;
      }
    }

    // Update send button state
    function updateSendButton(disabled) {
      const sendButton = document.getElementById("send-button");
      const input = document.getElementById("user-input");
      
      if (sendButton) {
        sendButton.disabled = disabled;
        if (disabled) {
          sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        } else {
          sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }
      }
      
      if (input) {
        input.disabled = disabled;
      }
    }

    // Add typing indicator
    function appendTypingIndicator(chatBox) {
      const typingDiv = document.createElement("div");
      typingDiv.className = "chat-message assistant-message typing-indicator";
      typingDiv.innerHTML = `
        <div class="message-avatar">
          <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
          <div class="typing-dots">
            <span>.</span><span>.</span><span>.</span>
          </div>
        </div>
      `;
      
      chatBox.appendChild(typingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      
      return typingDiv;
    }

    // Remove typing indicator
    function removeTypingIndicator(typingDiv) {
      if (typingDiv && typingDiv.parentNode) {
        typingDiv.remove();
      }
    }

    // Main sendMessage function
    async function sendMessage() {
      const input = document.getElementById('user-input');
      const chatBox = document.getElementById('chatBox');
      
      if (!input || !chatBox) {
        console.error('Chat elements not found');
        return;
      }
      
      const text = input.value.trim();
      if (!text || isProcessing) return;
      
      // Prevent multiple simultaneous requests
      isProcessing = true;
      updateSendButton(true);
      
      // Add user message to chat
      const userMessageDiv = document.createElement('div');
      userMessageDiv.className = 'chat-message user-message';
      userMessageDiv.innerHTML = `
        <div class="message-content">
          <p>${text}</p>
        </div>
      `;
      chatBox.appendChild(userMessageDiv);
      
      // Clear input
      input.value = '';
      input.style.height = 'auto';
      
      // Scroll to bottom
      chatBox.scrollTop = chatBox.scrollHeight;
      
      // Show typing indicator
      const typingDiv = appendTypingIndicator(chatBox);
      
      try {
        // Create thread if we don't have one
        if (!THREAD_ID) {
          await createThread();
        }
        
        console.log("Sending message to thread:", THREAD_ID);
        
        // Send API request
        const response = await fetch(`${API_BASE}/chat`, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ 
            message: text, 
            thread_id: THREAD_ID 
          }),
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Update thread ID if provided
        if (data.thread_id && data.thread_id !== THREAD_ID) {
          THREAD_ID = data.thread_id;
          localStorage.setItem("toursync_thread_id", THREAD_ID);
          console.log("Updated thread ID:", THREAD_ID);
        }
        
        // Remove typing indicator
        removeTypingIndicator(typingDiv);
        
        // Add AI response to chat
        const assistantMessage = data.response || "I'm sorry, I couldn't process that request.";
        const aiMessageDiv = document.createElement('div');
        aiMessageDiv.className = 'chat-message assistant-message';
        aiMessageDiv.innerHTML = `
          <div class="message-avatar">
            <i class="fas fa-robot"></i>
          </div>
          <div class="message-content">
            <p>${assistantMessage}</p>
          </div>
        `;
        chatBox.appendChild(aiMessageDiv);
        
        console.log("Message sent successfully");
        
      } catch (error) {
        console.error("Failed to send message:", error);
        removeTypingIndicator(typingDiv);
        
        let errorMessage = "❌ I'm having trouble connecting right now. Please try again in a moment.";
        
        if (error.message.includes("504")) {
          errorMessage = "❌ I'm taking longer than usual to respond. Please try again.";
        } else if (error.message.includes("500")) {
          errorMessage = "❌ I encountered an internal error. Please try again.";
        }
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'chat-message assistant-message';
        errorDiv.innerHTML = `
          <div class="message-avatar">
            <i class="fas fa-robot"></i>
          </div>
          <div class="message-content">
            <p>${errorMessage}</p>
          </div>
        `;
        chatBox.appendChild(errorDiv);
        
      } finally {
        isProcessing = false;
        updateSendButton(false);
        
        // Scroll to bottom
        chatBox.scrollTop = chatBox.scrollHeight;
        input.focus();
      }
    }
    
    // Initialize chat when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🎸 Initializing TourSync chat...');
      
      const userInput = document.getElementById('user-input');
      const sendButton = document.getElementById('send-button');
      
      // Handle Enter key
      if (userInput) {
        userInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
        
        // Auto-resize textarea
        userInput.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
      }
      
      // Handle send button click
      if (sendButton) {
        sendButton.addEventListener('click', sendMessage);
      }
      
      console.log('✅ TourSync chat system ready!');
    });

    // Venue Info Functions (replacing contact info)
    function showVenueInfo(venueName, email, phone, date, time) {
      // Create a simple modal for venue information
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      `;
      
      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 16px;
          padding: 2rem;
          max-width: 500px;
          width: 90%;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; color: var(--primary-color);">
              <i class="fas fa-music"></i> ${venueName}
            </h3>
            <button onclick="this.closest('div').remove()" style="
              background: none;
              border: none;
              font-size: 1.5rem;
              cursor: pointer;
              color: #666;
            ">&times;</button>
          </div>
          
          <div style="margin-bottom: 1.5rem;">
            <div style="
              display: flex;
              align-items: center;
              gap: 1rem;
              background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
              color: white;
              padding: 1rem;
              border-radius: 12px;
              margin-bottom: 1rem;
            ">
              <div style="
                width: 50px;
                height: 50px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
              ">
                <i class="fas fa-building"></i>
              </div>
              <div>
                <h4 style="margin: 0 0 0.5rem 0;">${venueName}</h4>
                <p style="margin: 0; opacity: 0.9;">
                  <i class="fas fa-calendar"></i> ${date} at ${time}
                </p>
              </div>
            </div>
          </div>
          
          <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
            <div style="
              display: flex;
              align-items: center;
              gap: 1rem;
              padding: 1rem;
              background: #f8f9fa;
              border-radius: 12px;
              border-left: 4px solid var(--primary-color);
            ">
              <div style="
                width: 40px;
                height: 40px;
                background: var(--primary-color);
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
              ">
                <i class="fas fa-envelope"></i>
              </div>
              <div style="flex: 1;">
                <label style="
                  display: block;
                  font-size: 0.8rem;
                  font-weight: 600;
                  color: #666;
                  text-transform: uppercase;
                  margin-bottom: 4px;
                ">Email</label>
                <p style="margin: 0 0 12px 0; font-size: 1.1rem; color: #333; font-weight: 500;">${email}</p>
                <button onclick="window.open('mailto:${email}?subject=Show Inquiry - ${date}', '_blank')" style="
                  background: var(--primary-color);
                  border: none;
                  color: white;
                  padding: 8px 16px;
                  border-radius: 6px;
                  font-size: 0.85rem;
                  cursor: pointer;
                  transition: all 0.3s ease;
                ">
                  <i class="fas fa-external-link-alt"></i> Send Email
                </button>
              </div>
            </div>
            
            <div style="
              display: flex;
              align-items: center;
              gap: 1rem;
              padding: 1rem;
              background: #f8f9fa;
              border-radius: 12px;
              border-left: 4px solid var(--primary-color);
            ">
              <div style="
                width: 40px;
                height: 40px;
                background: var(--primary-color);
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
              ">
                <i class="fas fa-phone"></i>
              </div>
              <div style="flex: 1;">
                <label style="
                  display: block;
                  font-size: 0.8rem;
                  font-weight: 600;
                  color: #666;
                  text-transform: uppercase;
                  margin-bottom: 4px;
                ">Phone</label>
                <p style="margin: 0 0 12px 0; font-size: 1.1rem; color: #333; font-weight: 500;">${phone}</p>
                <button onclick="window.open('tel:${phone}', '_blank')" style="
                  background: var(--primary-color);
                  border: none;
                  color: white;
                  padding: 8px 16px;
                  border-radius: 6px;
                  font-size: 0.85rem;
                  cursor: pointer;
                  transition: all 0.3s ease;
                ">
                  <i class="fas fa-phone-alt"></i> Call Now
                </button>
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button onclick="alert('Load-in details sent to band members!')" style="
              flex: 1;
              background: var(--primary-color);
              color: white;
              border: none;
              padding: 12px 20px;
              border-radius: 8px;
              font-size: 0.95rem;
              font-weight: 600;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
            ">
              <i class="fas fa-truck"></i> Load-in Info
            </button>
            <button onclick="alert('Show details updated in calendar!')" style="
              flex: 1;
              background: #f8f9fa;
              color: var(--primary-color);
              border: 2px solid #e9ecef;
              padding: 12px 20px;
              border-radius: 8px;
              font-size: 0.95rem;
              font-weight: 600;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
            ">
              <i class="fas fa-calendar-alt"></i> Update Show
            </button>
          </div>
        </div>
      `;
      
      // Close on click outside
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
      document.body.appendChild(modal);
    }

    // Band Details Function
    function showBandDetailsPopout(event) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      `;
      
      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 16px;
          padding: 0;
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow: hidden;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        ">
          <div style="
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <h3 style="margin: 0;">
              <i class="fas fa-users"></i> Band Details
            </h3>
            <button onclick="this.closest('div').remove()" style="
              background: none;
              border: none;
              color: white;
              font-size: 1.5rem;
              cursor: pointer;
            ">&times;</button>
          </div>
          
          <div style="padding: 24px; overflow-y: auto; max-height: calc(80vh - 80px);">
            <div style="text-align: center; margin-bottom: 24px;">
              <img src="https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb" 
                   style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 16px;">
              <h2 style="margin: 0 0 8px 0; color: var(--primary-color);">The Electric Collective</h2>
              <p style="margin: 0; color: #666;">
                <i class="fas fa-map-marker-alt"></i> Austin, Texas • Indie Rock
              </p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px;">
              <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 12px;">
                <i class="fas fa-users" style="color: var(--primary-color); font-size: 2rem; margin-bottom: 8px;"></i>
                <h4 style="margin: 0; color: var(--primary-color);">5 Members</h4>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">Full Band</p>
              </div>
              <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 12px;">
                <i class="fas fa-calendar" style="color: var(--success-color); font-size: 2rem; margin-bottom: 8px;"></i>
                <h4 style="margin: 0; color: var(--success-color);">15 Shows</h4>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">This Year</p>
              </div>
              <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 12px;">
                <i class="fas fa-route" style="color: var(--accent-color); font-size: 2rem; margin-bottom: 8px;"></i>
                <h4 style="margin: 0; color: var(--accent-color);">3 States</h4>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">Tour Range</p>
              </div>
            </div>
            
            <div style="margin-bottom: 24px;">
              <h4 style="margin-bottom: 16px; color: var(--primary-color);">Band Members</h4>
              <div style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                  <div style="width: 40px; height: 40px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">MJ</div>
                  <div>
                    <h5 style="margin: 0; color: var(--text-primary);">Mike Johnson</h5>
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">Lead Vocals, Rhythm Guitar</p>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                  <div style="width: 40px; height: 40px; background: var(--accent-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">SC</div>
                  <div>
                    <h5 style="margin: 0; color: var(--text-primary);">Sarah Chen</h5>
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">Lead Guitar, Backing Vocals</p>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                  <div style="width: 40px; height: 40px; background: var(--secondary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">AR</div>
                  <div>
                    <h5 style="margin: 0; color: var(--text-primary);">Alex Rodriguez</h5>
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">Bass Guitar</p>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                  <div style="width: 40px; height: 40px; background: var(--success-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">JT</div>
                  <div>
                    <h5 style="margin: 0; color: var(--text-primary);">Jordan Taylor</h5>
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">Drums, Percussion</p>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                  <div style="width: 40px; height: 40px; background: var(--warning-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">EK</div>
                  <div>
                    <h5 style="margin: 0; color: var(--text-primary);">Emma Kim</h5>
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">Keyboards, Synthesizers</p>
                  </div>
                </div>
              </div>
            </div>
            
            <div style="display: flex; gap: 12px;">
              <button onclick="alert('Opening band contact manager...')" style="
                flex: 1;
                background: var(--primary-color);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 0.95rem;
                font-weight: 600;
                cursor: pointer;
              ">
                <i class="fas fa-address-book"></i> Manage Contacts
              </button>
              <button onclick="alert('Opening gear management...')" style="
                flex: 1;
                background: #f8f9fa;
                color: var(--primary-color);
                border: 2px solid #e9ecef;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 0.95rem;
                font-weight: 600;
                cursor: pointer;
              ">
                <i class="fas fa-guitar"></i> Equipment List
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Close on click outside
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
      document.body.appendChild(modal);
    }

    // Placeholder functions for menu items
    function showAnalyticsPopout(event) {
      alert('Analytics: View your band\'s performance metrics, social media stats, and tour revenue analytics.');
    }

    function showTimelinePopout(event) {
      alert('Tour Timeline: Manage your tour schedule, track milestones, and coordinate logistics.');
    }

    function showOffersPopout(event) {
      alert('Bookings: View and manage venue bookings, gig offers, and show confirmations.');
    }

    function showSupportPopout(event) {
      alert('Support: Get help with tour planning, technical issues, or contact TourSync support.');
    }

    function showSettingsPopout(event) {
      alert('Settings: Manage your band profile, notification preferences, and account settings.');
    }

    function showDocumentsPopout(event) {
      alert('Documents: Store and manage contracts, setlists, tech riders, and other tour documents.');
    }

    function showCalendarPopout(event) {
      alert('Calendar: View and manage your tour dates, rehearsals, and band availability.');
    }

    // Expose functions globally
    window.sendMessage = sendMessage;
    window.showVenueInfo = showVenueInfo;
    window.showBandDetailsPopout = showBandDetailsPopout;
    window.showAnalyticsPopout = showAnalyticsPopout;
    window.showTimelinePopout = showTimelinePopout;
    window.showOffersPopout = showOffersPopout;
    window.showSupportPopout = showSupportPopout;
    window.showSettingsPopout = showSettingsPopout;
    window.showDocumentsPopout = showDocumentsPopout;
    window.showCalendarPopout = showCalendarPopout;
  </script>
</body>
</html>